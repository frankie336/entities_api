graph TD
    %% NODES
    User([User Query])
    Web[(Internet / Tools)]
    DB[(Database / History)]

    %% MAIN ENTRY POINT
    subgraph MainThread ["Main Thread (Persistent Context)"]
        direction TB
        Orchestrator{QwenWorker<br>Orchestrator}
        CheckConfig{Is Deep Research?}

        %% STANDARD PATH
        MainAsst[Main Assistant Logic]

        %% SUPERVISOR SETUP
        SpawnSup[Spawn Ephemeral Supervisor]
        Supervisor[<b>Supervisor Agent</b><br><i>Manager</i>]

        %% POST-RESEARCH STATE
        SupervisorUpdate[Supervisor Receives Report<br><i>Updates Context Only</i>]
        Cleanup[Cleanup Supervisor<br>& Persist to Thread]
    end

    %% DELEGATION LOGIC
    subgraph Bridge ["DelegationMixin (Bridge)"]
        MixinHandle[handle_delegate_research_task]
        StreamProxy[Stream Proxy<br><i>Relays Worker Events to User</i>]
        FetchReport[_fetch_worker_final_report]
        SubmitOut[submit_tool_output]
    end

    %% ISOLATED WORKER
    subgraph EphemeralThread ["Ephemeral Thread (Isolated Context)"]
        direction TB
        CreateEnv[Create Worker & Thread]
        WorkerAgent[<b>Worker Agent</b><br><i>Researcher</i>]

        subgraph WorkerLoop ["Worker Loop"]
            Thinking[Reasoning / Thoughts]
            Tools[Tool Execution<br>Search/Read/Scroll]
        end

        Synthesis[<b>Final Answer Synthesis</b><br><i>Worker writes conclusion</i>]
    end

    %% FLOW CONNECTIONS
    User --> Orchestrator
    Orchestrator --> CheckConfig

    %% Standard Route
    CheckConfig -- "No" --> MainAsst
    MainAsst --> |"Direct Response"| User

    %% Deep Research Route
    CheckConfig -- "Yes" --> SpawnSup
    SpawnSup --> Supervisor
    Supervisor -- "Tool Call:<br>delegate_research_task" --> MixinHandle

    %% Spawning the Worker
    MixinHandle --> CreateEnv
    CreateEnv --> WorkerAgent

    %% The Research Loop
    WorkerAgent --> Thinking
    Thinking --> Tools
    Tools <--> Web
    Tools --> WorkerAgent

    %% CRITICAL: REAL-TIME STREAMING TO USER
    Thinking -.-> |"Stream (Real-time)"| StreamProxy
    Tools -.-> |"Stream (Activity)"| StreamProxy
    Synthesis -.-> |"Stream (Final Answer)"| StreamProxy
    StreamProxy ==> |"Yield Events"| User

    %% Worker Finalization
    WorkerAgent --> Synthesis
    Synthesis --> |"End of Stream"| FetchReport

    %% Sync Back to Main Thread
    FetchReport -- "Extract content<br>from last msg" --> SubmitOut
    SubmitOut -- "Tool Output" --> SupervisorUpdate

    %% Final Cleanup
    SupervisorUpdate --> Cleanup
    Cleanup --> DB
    DB --> NextTurn([Ready for Next Turn])

    %% ==========================================
    %% DARK MODE STYLING
    %% ==========================================

    %% 1. Main Thread: Deep Slate Blue with Cyan Border
    classDef main fill:#0f172a,stroke:#38bdf8,stroke-width:2px,color:#fff;

    %% 2. Worker Thread: Deep Brown/Orange with Bright Orange Border
    classDef worker fill:#431407,stroke:#fb923c,stroke-width:2px,color:#fff;

    %% 3. Bridge/Mixin: Deep Purple with Neon Purple Border
    classDef bridge fill:#2e1065,stroke:#d8b4fe,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;

    %% 4. External Nodes: Dark Grey with Green/White Border
    classDef external fill:#262626,stroke:#4ade80,stroke-width:2px,color:#fff;

    %% Apply Classes
    class Supervisor,Orchestrator,MainAsst,SupervisorUpdate,CheckConfig,SpawnSup,Cleanup main;
    class WorkerAgent,Tools,Synthesis,Thinking,CreateEnv worker;
    class MixinHandle,FetchReport,SubmitOut,StreamProxy bridge;
    class User,Web,DB,NextTurn external;

    %% Make Subgraph Backgrounds Transparent/Dark using the ID
    style MainThread fill:#1e293b,stroke:#475569,color:#fff
    style Bridge fill:#171717,stroke:#6b21a8,color:#fff
    style EphemeralThread fill:#271a12,stroke:#c2410c,color:#fff
    style WorkerLoop fill:#000000,stroke:#fb923c,stroke-dasharray: 5 5,color:#fff