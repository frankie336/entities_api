# Matrix: Adding a New Inference Provider

| Component/Area             | Task Description                                                                                                                                                    | Key Files/Locations (Examples)                                  | Effort Estimate | Notes                                                                                               |
|---------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|----------------|-----------------------------------------------------------------------------------------------------|
| 1. Configuration           | Add API keys, base URLs, or other necessary credentials/endpoints for the new provider.                                                                             | `.env`, `config/settings.py`, Secret Manager                    | Low            | Standard configuration management.                                                                  |
| 2. MODEL_MAP               | Add entries for the new provider's models using the established prefix convention (e.g., `"anthropic/claude-3-opus-20240229": "claude-3-opus-20240229"`).         | `projectdavid_common/constants/ai_model_map.py`                 | Low            | Requires knowing the provider's model IDs and your desired unified naming.                          |
| 3. Specific Child Handler(s) | CREATE new Python class(es) (e.g., `AnthropicClaude3OpusHandler`) inheriting from your base inference class (e.g., `BaseInference`).                                 | `entities_api/inference/specific_handlers/anthropic_handlers.py` | High           | Core implementation work. Includes provider SDK usage, streaming logic, error handling, etc.        |
| 4. General Dispatcher Handler | CREATE a new class (e.g., `AnthropicHandler`). Implement `__init__`, `SUBMODEL_CLASS_MAP`, and delegation methods (e.g., `process_conversation`, `stream`).       | `entities_api/inference/handlers/anthropic_handler.py`          | Medium         | Mostly boilerplate delegation logic and sub-handler routing.                                        |
| 5. InferenceProviderSelector | MODIFY existing selector. Import the new handler and map the provider prefix to the general handler class.                                                        | `entities_api/inference/inference_provider_selector.py`         | Low            | Minimal changeâ€”add one entry to routing map (e.g., `"anthropic/"`).                                 |
| 6. InferenceArbiter        | No code changes required. Instantiation and caching is handled generically.                                                                                        | `entities_api/inference/inference_arbiter.py`                   | None           | Key benefit: core caching requires no modification.                                                 |
| 7. Testing                 | CREATE unit tests for child handlers and dispatcher handler. Mock API calls and validate routing logic. Optionally add integration tests.                          | `tests/inference/specific_handlers/`                            | Medium         | Ensure functional and routing correctness across interfaces.                                        |
