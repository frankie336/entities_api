graph TD
    %% ==========================================
    %% NODES & EXTERNAL ACTORS
    %% ==========================================
    LLM([LLM Decision<br>Generate Code])
    User([User Client<br>Receives Stream])

    %% ==========================================
    %% SUBGRAPH: BACKEND (The Controller)
    %% ==========================================
    subgraph Backend ["Backend Service (CodeExecutionMixin)"]
        direction TB
        MixinStart[<b>handle_code_interpreter</b><br><i>Validate & Init</i>]

        subgraph StreamLogic ["Streaming Logic"]
            HotCode[Stream Hot Code<br>to User]
            ProcessStream[<b>Stream Processing Loop</b><br><i>Decodes WS messages</i>]
            CheckFiles{Message contains<br>uploaded_files?}
            FetchB64[<b>Fetch Base64</b><br><i>get_file_as_base64</i>]
            YieldFile[Yield 'generated_file'<br>Chunk]
        end
    end

    %% ==========================================
    %% SUBGRAPH: BRIDGE (WebSocket Client)
    %% ==========================================
    subgraph Bridge ["CodeExecutionClient (WebSocket)"]
        WS_Connect[Connect & Auth]
        WS_Send[Send JSON: <br>Code + Metadata]
        WS_Recv[Receive Generator]
    end

    %% ==========================================
    %% SUBGRAPH: SANDBOX (Isolated Environment)
    %% ==========================================
    subgraph SandboxEnv ["Sandbox Environment (Docker/Firejail)"]
        direction TB
        Handler[<b>StreamingHandler</b><br><i>execute_code_streaming</i>]

        subgraph ExecProcess ["Execution Context"]
            PythonProc[<b>Python Process</b><br><i>subprocess/firejail</i>]
            LocalDisk[("/generated_files/temp.png")]
        end

        FileDetector[<b>Upload Logic</b><br><i>_upload_generated_files</i>]
        Cleanup[Cleanup Temp Files]
    end

    %% ==========================================
    %% SUBGRAPH: INFRASTRUCTURE (Storage)
    %% ==========================================
    subgraph Infra ["File Infrastructure (FileService)"]
        direction TB
        FileAPI[<b>FileService API</b><br><i>Entity Client</i>]
        DB[(Postgres DB<br>File Metadata)]
        Samba[(Samba Storage<br>Physical Bytes)]
    end

    %% ==========================================
    %% DATA FLOW CONNECTIONS
    %% ==========================================

    %% 1. INITIATION
    LLM --> |"Args: {code: 'plt.savefig...'}"| MixinStart
    MixinStart --> HotCode
    HotCode -.-> |"Echo Code"| User
    MixinStart --> WS_Connect
    WS_Connect --> WS_Send

    %% 2. EXECUTION HANDOFF
    WS_Send ==> |"WS: Execute Code"| Handler
    Handler --> PythonProc
    PythonProc -- "Writes File" --> LocalDisk

    %% 3. SANDBOX INTERNAL UPLOAD (The "Magic" Step)
    PythonProc -.-> |"Process Complete"| FileDetector
    FileDetector -- "Scans Dir" --> LocalDisk
    FileDetector -- "HTTP Upload" --> FileAPI

    %% 4. PERSISTENCE
    FileAPI --> |"Save Metadata"| DB
    FileAPI --> |"Write Bytes"| Samba
    FileAPI -- "Return File ID" --> FileDetector

    %% 5. RESULT HANDOFF
    FileDetector --> Cleanup
    FileDetector -- "WS Msg: Status Complete<br>+ File IDs" --> WS_Recv
    WS_Recv --> ProcessStream

    %% 6. RETRIEVAL & STREAMING
    ProcessStream --> CheckFiles
    CheckFiles -- "Yes (File IDs found)" --> FetchB64

    %% The Fetch Loop
    FetchB64 -- "Query ID" --> DB
    FetchB64 -- "Read Bytes" --> Samba
    Samba -.-> |"Return Base64"| FetchB64

    %% 7. FINAL DELIVERY
    FetchB64 --> YieldFile
    YieldFile ==> |"JSON Chunk:<br>{type: generated_file, base64: ...}"| User

    %% ==========================================
    %% STYLING (Based on provided reference)
    %% ==========================================

    %% 1. Backend: Deep Slate Blue with Cyan Border
    classDef main fill:#0f172a,stroke:#38bdf8,stroke-width:2px,color:#fff;

    %% 2. Sandbox: Deep Brown/Orange with Bright Orange Border
    classDef worker fill:#431407,stroke:#fb923c,stroke-width:2px,color:#fff;

    %% 3. Bridge: Deep Purple with Neon Purple Border
    classDef bridge fill:#2e1065,stroke:#d8b4fe,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;

    %% 4. External/Infra: Dark Grey with Green/White Border
    classDef external fill:#262626,stroke:#4ade80,stroke-width:2px,color:#fff;

    %% Apply Classes
    class MixinStart,StreamLogic,ProcessStream,CheckFiles,FetchB64,YieldFile,HotCode main;
    class SandboxEnv,Handler,PythonProc,FileDetector,Cleanup,LocalDisk worker;
    class WS_Connect,WS_Send,WS_Recv bridge;
    class LLM,User,Infra,FileAPI,DB,Samba external;

    %% Subgraph Styles
    style Backend fill:#1e293b,stroke:#475569,color:#fff
    style Bridge fill:#171717,stroke:#6b21a8,color:#fff
    style SandboxEnv fill:#271a12,stroke:#c2410c,color:#fff
    style Infra fill:#171717,stroke:#15803d,color:#fff
    style ExecProcess fill:#000000,stroke:#fb923c,stroke-dasharray: 5 5,color:#fff